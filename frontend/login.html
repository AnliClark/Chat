<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Let's Chat!</title>
</head>
<style>
    .login-container::before
    {
        content: '';
        position:absolute;
        width: 99%;
        height: 98%;
        background:url(chatbackground.jpg) no-repeat;
        background-size: cover;
        /* 设置背景的不透明度 */
        opacity: 0.7;
        border-radius: 10px;
        /* padding: 4px; */
        /* animation: anim 20s linear infinite; */
    }
    /* @keyframes anim
    {
        50%
        {
            transform: scale(2);
        }
        100%{
            transform: scale(1);
        }
    } */
    .login-container h1{
        font-family:monospace;
        position: absolute;
        font-size: 14em;
        left: 150px;
        color: #75848b;
    }
    .container
    {
        position: absolute;
        top: 200px;
        left: 800px;
        height: 210px;
        width: 350px;
        background-color: #acc3cd;
        align-items: center;
        border-radius: 10px;
        opacity: 0.9;
        padding: 20px;
    }
    .container h2{
        position: absolute;
        top:10px;
        left: 110px;
        font-family: monospace;
        font-size: 2.5em;
        color: #424d53;
        /* width: 30px; */
        
    }
    .username
    {
        position: absolute;
        top: 100px;
        left:90px;
        border-radius: 5px;
        width: 200px;
        height: 15px;
        border: none;
        padding: 5px;
        font-family:'Times New Roman', Times, serif;
        font-size: 0.9em;
    }
    .password
    {
        position: absolute;
        top: 135px;
        left:90px;
        border-radius: 5px;
        width: 200px;
        height: 15px;
        border: none;
        padding: 5px;
        font-family:'Times New Roman', Times, serif;
        font-size: 0.9em;
    }
    .loginbtn{
        position: absolute;
        top:170px;
        left: 145px;
        height: 20px;
        width: 100px;
        border: none;
        border-radius: 2px;
        font-family: monospace;
        font-size: 1.1em;
        color: #424d53;
        
    }
    .register
    {
        position: absolute;
        top:198px;
        left: 145px;
        height: 20px;
        width: 100px;
        border: none;
        border-radius: 2px;
        font-family: monospace;
        font-size: 1.1em;
        color: #424d53;
    }  
</style>
<body>
    <div class="login-container">
        <h1>Let's <br>Chat!</h1>
        <div class="container">
            <h2>User Login</h2>
            <input class="username" type="text" id="username" placeholder="Enter your username" required>
            <button class="loginbtn" id="loginButton">Login</button>
            <input class="password" type="password" id="password" placeholder="Password">
            <button class="register" id="registerButton">Register</button>
        </div>
    <script >
        // 客户端发给服务端的消息：
        // request={
        //      "type":"login", 
        //      "username": string 
        //      "password": string
        // }
        //服务端返回的响应消息为：
        // response={
        //      "type": "login_response",
        //      "success": true,
        //      "username": str
        //      "image_id": int
        // }
        // response={
        //      "type": "login_response",
        //      "success": false,
        //      "error": str
        // }
        //
        // 客户端发给服务端的消息：
        // request={
        //      "type":"register", 
        //      "username": string 
        //      "password": string
        // }
        //服务端返回的响应消息为：
        // response={
        //      "type": "register_response",
        //      "success": bool
        // }
        const ws = new WebSocket('ws://127.0.0.1:3030/login');
        ws.onopen = function() {
            console.log('Connected to WebSocket');
        };
        ws.onmessage = function(event){
            const data = JSON.parse(event.data);  // data中有success(bool)和username(string)
            if(data.type === 'login_response'){
                if (data.success) {
                    localStorage.setItem('username', data.username);   // 设置用户名
                    localStorage.setItem('imageId', data.image_id);   // 设置密码
                    var pathname = window.location.pathname;
                    if(pathname.search('html')==-1){
                        window.location.href = 'wechat';
                    }else{
                        window.location.href = 'wechat.html';  
                    }
                }else {
                    alert(data.error);
                }
            }else{
                if (data.success) {
                    alert('注册成功，请登录');
                } else {
                    alert('用户名已被占用，请更换用户名');
                }
            }
            
        };
        // 登录部分
        document.getElementById('loginButton').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            ws.send(JSON.stringify({ "type":"login", "username": username, "password": password }));
        });
        // 注册部分
        document.getElementById('registerButton').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if(username == "undefined" || username == ""){
                alert("请输入合法的用户名")
            }else if(password == "" || password == "undefined"){
                alert("请输入合法的密码")
            }
            else{
                ws.send(JSON.stringify({ "type":"register", "username": username, "password": password }));
            }
        });
        
    </script>
</body>
</html>
